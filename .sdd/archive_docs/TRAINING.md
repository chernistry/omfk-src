# OMFK ‚Äî –û–±—É—á–µ–Ω–∏–µ –ú–æ–¥–µ–ª–µ–π

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –û–¥–∏–Ω –≤—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ü–æ—á—Ç–∏ –≤—Å—ë (–∫–æ—Ä–ø—É—Å–∞ ‚Üí n-grams ‚Üí CoreML ‚Üí —Ç–µ—Å—Ç—ã) –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
./omfk.sh --help
```

–ë—ã—Å—Ç—Ä—ã–π —á–µ–∫ —Å—Ç–∞—Ç—É—Å–∞ (—á—Ç–æ –µ—Å—Ç—å / —á—Ç–æ —É—Å—Ç–∞—Ä–µ–ª–æ / —á—Ç–æ –Ω–∞–¥–æ –∑–∞–ø—É—Å–∫–∞—Ç—å):
```bash
./omfk.sh status
```

---

## üìö –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ?

### 1. **N-gram –º–æ–¥–µ–ª–∏** (Fast Path)
- **–ì–¥–µ**: `Tools/NgramTrainer/`
- **–ß—Ç–æ –¥–µ–ª–∞—é—Ç**: –ë—ã—Å—Ç—Ä–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø–æ —Ç—Ä–∏–≥—Ä–∞–º–º–∞–º
- **–ú–æ–¥–µ–ª–∏**: RU, EN, HE
- **–†–∞–∑–º–µ—Ä**: ~50-100 KB –∫–∞–∂–¥–∞—è
 - **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**: unigram-–ª–µ–∫—Å–∏–∫–æ–Ω—ã (—á–∞—Å—Ç–æ—Ç—ã —Å–ª–æ–≤) –¥–ª—è:
   - –¥–∏–∑–∞–º–±–∏–≥—É–∞—Ü–∏–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö —Ä–∞—Å–∫–ª–∞–¥–æ–∫ (Hebrew QWERTY –¥—É–±–ª–∏–∫–∞—Ç—ã)
   - –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–ª–æ–≤, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ macOS –Ω–µ—Ç —Å–ª–æ–≤–∞—Ä—è (—á–∞—Å—Ç–æ –¥–ª—è Hebrew)

### 2. **CoreML –º–æ–¥–µ–ª—å** (Deep Path)
- **–ì–¥–µ**: `Tools/CoreMLTrainer/`
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞)
- **–†–∞–∑–º–µ—Ä**: ~150 KB

---

## üéØ –ü–æ—à–∞–≥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ

### 0) –ü–æ–Ω—è—Ç—å, —á—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ (–∏ –Ω—É–∂–Ω–æ –ª–∏ —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ—É—á–∏–≤–∞—Ç—å)

```bash
./omfk.sh status
```

–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—É—á–∏–≤–∞—Ç—å:
- **–ü–æ–º–µ–Ω—è–ª–∏—Å—å** `data/processed/{ru,en,he}.txt` ‚Üí –ø–µ—Ä–µ—É—á–∏—Ç—å `train ngrams` (–∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ CoreML).
- **–ü–æ–º–µ–Ω—è–ª–∏—Å—å —Ä–∞—Å–∫–ª–∞–¥–∫–∏** (`.sdd/layouts.json` –∏–ª–∏ `OMFK/Sources/Resources/layouts.json`) ‚Üí –ø–µ—Ä–µ—É—á–∏—Ç—å CoreML (–º–∏–Ω–∏–º—É–º) –∏, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ç—å –¥–∞—Ç–∞—Å–µ—Ç.
- **–ù–µ—Ç —á–µ–∫–ø–æ–π–Ω—Ç–æ–≤** `Tools/CoreMLTrainer/model_production*.pth` ‚Üí —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (CoreML `.mlmodel` —É–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–æ—Ç–æ–≤), –Ω–æ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç—Ä–µ–Ω–∏–Ω–≥/—Ñ–∞–π–Ω—Ç—é–Ω ‚Äî –Ω—É–∂–µ–Ω —Ä–µ-—Ç—Ä–µ–π–Ω.

### 1) N-gram –º–æ–¥–µ–ª–∏ (RU/EN/HE) + unigram-–ª–µ–∫—Å–∏–∫–æ–Ω—ã

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ—Ä–ø—É—Å–∞ –∏–∑ `data/processed/*.txt`:

```bash
./omfk.sh train ngrams
```

–ü–æ–ª–µ–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `OMFK_UNIGRAM_TOP=200000` (—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ unigram-–ª–µ–∫—Å–∏–∫–æ–Ω)

### 2) CoreML –º–æ–¥–µ–ª—å (base + optional fine-tune he_qwerty)

–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: (re)train ‚Üí export ‚Üí validate_export ‚Üí install –≤ —Ä–µ—Å—É—Ä—Å—ã ‚Üí `swift test`.

```bash
./omfk.sh train coreml
```

Ultra (–º–∞–∫—Å–∏–º—É–º –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –¥–æ–ª–≥–æ):
```bash
OMFK_ULTRA=1 ./omfk.sh train coreml
```

### ‚öôÔ∏è –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—á–µ—Ä–µ–∑ `train_master.sh 3`)

`train_master.sh 3` –º–æ–∂–Ω–æ —Ç–æ–Ω–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

- `OMFK_BASE_DATASET` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `training_data_combined.csv`) ‚Äî –±–∞–∑–æ–≤—ã–π CSV –¥–ª—è –æ–±—É—á–µ–Ω–∏—è.
- `OMFK_FORCE_RETRAIN=1` ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –±–∞–∑–æ–≤—É—é –º–æ–¥–µ–ª—å, –¥–∞–∂–µ –µ—Å–ª–∏ `model_production.pth` —É–∂–µ –µ—Å—Ç—å.
- `OMFK_FORCE_REGEN_DATA=1` ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –¥–∞—Ç–∞—Å–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ CSV —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
- `OMFK_SKIP_HE_QWERTY_FINETUNE=1` ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π fine-tune –ø–æ–¥ Hebrew QWERTY (–µ—Å–ª–∏ –±–∞–∑–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç —É–∂–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç `he_qwerty`).
- `OMFK_MAX_CORPUS_WORDS` ‚Äî —Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ `data/processed/{ru,en,he}.txt` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0 = –≤—Å–µ, –º–µ–¥–ª–µ–Ω–Ω–æ/–ø–∞–º—è—Ç—å).
- `OMFK_CORPUS_SAMPLE_MODE=head|reservoir` ‚Äî –∫–∞–∫ —Å–µ–º–ø–ª–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–≤–∞ –∏–∑ –±–æ–ª—å—à–∏—Ö –∫–æ—Ä–ø—É—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `reservoir`).
- `OMFK_ULTRA=1` ‚Äî ‚Äú—É–ª—å—Ç—Ä–∞‚Äù –ø—Ä–µ—Å–µ—Ç (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç sample/epoch –∏ —Å—Ç–∞–≤–∏—Ç `OMFK_MAX_CORPUS_WORDS=0`).

–¢–æ –∂–µ —Å–∞–º–æ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è `./omfk.sh train coreml` (—ç—Ç–æ —Ç–µ–ø–µ—Ä—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø—É—Ç—å).

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã:

```bash
./omfk.sh test
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚úî Test Suite 'All tests' passed
```

### üß™ Synthetic evaluation (–∞–≤—Ç–æ—Ç–µ—Å—Ç ‚Äú–∫–∞–∫ —é–∑–µ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ‚Äù)

–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ–ª—å—à–æ–π —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π –Ω–∞–±–æ—Ä –∫–µ–π—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö 9 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π EN/RU/HE (–≤–∫–ª—é—á–∞—è ‚Äú—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ‚Äù, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å –ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è):

```bash
OMFK_SYNTH_EVAL_MIN_OUTPUT_ACC=98 ./omfk.sh eval synthetic
```

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `OMFK_SYNTH_EVAL_CASES_PER_LANG` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `300`)
- `OMFK_SYNTH_EVAL_SEED` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `42`)
- `OMFK_SYNTH_EVAL_MIN_OUTPUT_ACC` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø—Ä–æ—Ü–µ–Ω—Ç, —á—Ç–æ–±—ã —Ñ–µ–π–ª–∏—Ç—å —Ç–µ—Å—Ç –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
OMFK/
‚îú‚îÄ‚îÄ omfk.sh                      ‚Üê –ï–î–ò–ù–´–ô –º–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç (–∑–∞–ø—É—Å–∫–∞–π—Ç–µ –µ–≥–æ!)
‚îú‚îÄ‚îÄ train_all_models.sh          ‚Üê wrapper (deprecated, –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
‚îú‚îÄ‚îÄ train_master.sh              ‚Üê –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é-–æ–±—ë—Ä—Ç–∫–∞ (deprecated)
‚îú‚îÄ‚îÄ Tools/
‚îÇ   ‚îú‚îÄ‚îÄ NgramTrainer/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md             ‚Üê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è N-gram
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ train_ngrams.py       ‚Üê –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ corpora/              ‚Üê –ö–æ—Ä–ø—É—Å–∞ —Ç–µ–∫—Å—Ç–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ CoreMLTrainer/
‚îÇ       ‚îú‚îÄ‚îÄ README.md             ‚Üê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è CoreML
‚îÇ       ‚îú‚îÄ‚îÄ train_quick.sh        ‚Üê wrapper (deprecated)
‚îÇ       ‚îú‚îÄ‚îÄ train_full.sh         ‚Üê wrapper (deprecated)
‚îÇ       ‚îú‚îÄ‚îÄ generate_data.py      ‚Üê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îÇ       ‚îú‚îÄ‚îÄ train.py              ‚Üê –û–±—É—á–µ–Ω–∏–µ PyTorch
‚îÇ       ‚îî‚îÄ‚îÄ export.py             ‚Üê –≠–∫—Å–ø–æ—Ä—Ç –≤ CoreML
‚îî‚îÄ‚îÄ OMFK/Sources/Resources/
    ‚îú‚îÄ‚îÄ LanguageModels/           ‚Üê N-gram –º–æ–¥–µ–ª–∏ (JSON)
    ‚îÇ   ‚îú‚îÄ‚îÄ ru_trigrams.json
    ‚îÇ   ‚îú‚îÄ‚îÄ en_trigrams.json
    ‚îÇ   ‚îî‚îÄ‚îÄ he_trigrams.json
    ‚îÇ   ‚îú‚îÄ‚îÄ ru_unigrams.tsv
    ‚îÇ   ‚îú‚îÄ‚îÄ en_unigrams.tsv
    ‚îÇ   ‚îî‚îÄ‚îÄ he_unigrams.tsv
    ‚îî‚îÄ‚îÄ LayoutClassifier.mlmodel  ‚Üê CoreML –º–æ–¥–µ–ª—å
```

---

## üîß –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Python 3.8+** (–¥–ª—è –æ–±—É—á–µ–Ω–∏—è)
- **Swift 5.10+** (–¥–ª—è —Å–±–æ—Ä–∫–∏)
- **macOS 14+** (–¥–ª—è –∑–∞–ø—É—Å–∫–∞)

### Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (CoreML):
```bash
cd Tools/CoreMLTrainer
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

---

## üí° –î–ª—è production

### N-gram –º–æ–¥–µ–ª–∏:
1. –°–∫–∞—á–∞–π—Ç–µ –±–æ–ª—å—à–∏–µ –∫–æ—Ä–ø—É—Å–∞ (Wikipedia, OpenSubtitles)
2. –û–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –Ω–∏—Ö
3. –ó–∞–º–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã –≤ `OMFK/Sources/Resources/LanguageModels/`

### CoreML –º–æ–¥–µ–ª—å:
1. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ—Ä–ø—É—Å–∞ –≤ `data/processed/*`:
   - `./omfk.sh corpus extract-wikipedia --lang ru|en|he ...`
   - `./omfk.sh corpus download-subtitles --limit ...`
   - `./omfk.sh corpus import-telegram --file ...`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `OMFK_ULTRA=1 ./omfk.sh train coreml`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ: `OMFK_SYNTH_EVAL_MIN_OUTPUT_ACC=98 ./omfk.sh eval synthetic`

---

## üêõ Troubleshooting

**"Model not found"**
‚Üí –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–æ–¥–µ–ª–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ `OMFK/Sources/Resources/`

**"Module 'torch' not found"**
‚Üí –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ venv: `source Tools/CoreMLTrainer/venv/bin/activate`

**–ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å**
‚Üí –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –∏ —ç–ø–æ—Ö –æ–±—É—á–µ–Ω–∏—è

**–¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç**
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –º–µ—Å—Ç–µ: `ls -l OMFK/Sources/Resources/`

**–ù—É–∂–Ω–æ ‚Äú–ø—Ä—è–º —Å –Ω—É–ª—è‚Äù**
- –£–¥–∞–ª–∏ `Tools/CoreMLTrainer/model_production*.pth` –∏/–∏–ª–∏ –ø–æ—Å—Ç–∞–≤—å `OMFK_FORCE_RETRAIN=1`
- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ø–æ—Å—Ç–∞–≤—å `OMFK_FORCE_REGEN_DATA=1` –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–∞–Ω–æ–≤–æ —Å–≥–µ–Ω–µ—Ä–∏—Ç—å CSV
